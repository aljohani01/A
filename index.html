<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>جمعية مناسبات الكشوش</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* أنماط CSS كما هي موجودة في الكود السابق */
        /* ... */
        
        /* أضفنا زر الحفظ الثابت في الأسفل */
        #saveDataBtn {
            position: fixed;
            bottom: 100px;
            right: 20px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            padding: 15px 25px;
            font-size: 1.1rem;
            display: none; /* مخفي حتى يتم الدخول كمسؤول */
        }
        
        /* نافذة عرض البيانات للنسخ */
        .data-display {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 9999;
            padding: 20px;
            overflow: auto;
            font-family: monospace;
            font-size: 16px;
            line-height: 1.5;
        }
        
        .data-display textarea {
            width: 100%;
            height: 90%;
            border: none;
            padding: 15px;
            font-family: monospace;
            font-size: 16px;
            resize: none;
        }
        
        .data-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <!-- ... باقي الهيكل كما هو ... -->
    
    <!-- زر الحفظ (يظهر فقط للمسؤول) -->
    <button id="saveDataBtn" class="btn btn-success">
        <i class="fas fa-save"></i> حفظ البيانات على GitHub
    </button>
    
    <!-- ... باقي التذييل ونافذة الدخول ... -->
    
    <script>
        // بيانات المسؤول
        const ADMIN_USERNAME = "abdulaziz";
        const ADMIN_PASSWORD = "ySRgq4#4qThaYm0d";

        // مسار ملف البيانات على GitHub (يجب تحديثه بمستودعك)
        const DATA_FILE_URL = "https://raw.githubusercontent.com/aljohani01/a/[الفرع]/data.json";

        // حالة المسؤول
        let isAdmin = false;

        // العناصر الرئيسية في DOM
        const eventsTableBody = document.querySelector('#eventsTable tbody');
        const paymentsTableBody = document.querySelector('#paymentsTable tbody');
        const eventsTotalEl = document.getElementById('eventsTotal');
        const paymentsTotalEl = document.getElementById('paymentsTotal');
        const remainingAmountEl = document.getElementById('remainingAmount');
        const summaryEventsEl = document.getElementById('summaryEvents');
        const summaryPaymentsEl = document.getElementById('summaryPayments');
        const summaryRemainingEl = document.getElementById('summaryRemaining');
        const currentYearEl = document.getElementById('currentYear');
        const dateDisplayEl = document.getElementById('dateDisplay');
        const lastUpdateEl = document.getElementById('lastUpdate');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const addEventBtn = document.getElementById('addEventBtn');
        const addPaymentBtn = document.getElementById('addPaymentBtn');
        const loginModal = document.getElementById('loginModal');
        const loginBtn = document.getElementById('loginBtn');
        const closeLoginBtn = document.getElementById('closeLoginBtn');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const saveDataBtn = document.getElementById('saveDataBtn');

        // تهيئة التطبيق
        async function initApp() {
            // تعيين السنة الحالية
            currentYearEl.textContent = new Date().getFullYear();
            
            // محاولة تحميل البيانات من GitHub
            await loadDataFromGitHub();
            
            // تحديث تاريخ آخر تعديل
            updateLastUpdate();
            
            // إضافة مستمعي الأحداث
            setupEventListeners();
            
            // تحميل البيانات الأولية
            renderData();
        }

        // تحميل البيانات من GitHub
        async function loadDataFromGitHub() {
            try {
                // إضافة طابع زمني لمنع التخزين المؤقت
                const response = await fetch(`${DATA_FILE_URL}?t=${new Date().getTime()}`);
                
                if (!response.ok) {
                    throw new Error('فشل في تحميل البيانات');
                }
                
                const data = await response.json();
                window.appData = data;
                console.log('تم تحميل البيانات بنجاح من GitHub');
            } catch (error) {
                console.error('خطأ في تحميل البيانات من GitHub:', error);
                // استخدام بيانات افتراضية في حالة فشل التحميل
                window.appData = {
                    events: [
                        { name: "مسند", date: "1446/12/01هـ", amount: 500 },
                        { name: "علي", date: "1446/12/05هـ", amount: 500 },
                        { name: "سعود", date: "1446/12/10هـ", amount: 500 },
                        { name: "مازن", date: "1446/12/12هـ", amount: 500 },
                        { name: "عبدالعزيز", date: "1446/12/15هـ", amount: 500 },
                        { name: "ابراهيم", date: "1446/12/20هـ", amount: 500 },
                        { name: "سعد", date: "1446/12/25هـ", amount: 500 }
                    ],
                    payments: [
                        { name: "مثال", amount: 1000 }
                    ],
                    currentDate: "1446/12/30هـ",
                    lastUpdate: null
                };
            }
            
            // تعيين التاريخ الحالي
            dateDisplayEl.textContent = window.appData.currentDate;
        }

        // تحديث تاريخ آخر تعديل
        function updateLastUpdate() {
            if (window.appData.lastUpdate) {
                lastUpdateEl.textContent = window.appData.lastUpdate;
            } else {
                lastUpdateEl.textContent = 'لم يتم تحديثه بعد';
            }
        }

        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // تسجيل الدخول للمسؤول
            adminLoginBtn.addEventListener('click', () => {
                loginModal.style.display = 'flex';
                usernameInput.focus();
            });
            
            // تسجيل الدخول
            loginBtn.addEventListener('click', login);
            
            // إغلاق نافذة التسجيل
            closeLoginBtn.addEventListener('click', () => {
                loginModal.style.display = 'none';
            });
            
            // تسجيل الخروج
            logoutBtn.addEventListener('click', logout);
            
            // إضافة مناسبة
            addEventBtn.addEventListener('click', addNewEvent);
            
            // إضافة دفعة
            addPaymentBtn.addEventListener('click', addNewPayment);
            
            // تعديل التاريخ
            dateDisplayEl.addEventListener('click', () => {
                if (!isAdmin) return;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = window.appData.currentDate;
                input.className = 'date-input';
                
                dateDisplayEl.replaceWith(input);
                input.focus();
                
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') saveDate(input);
                });
                
                input.addEventListener('blur', () => saveDate(input));
            });
            
            // مستمع لزر الحفظ
            saveDataBtn.addEventListener('click', showDataForCopy);
        }

        // تسجيل الدخول
        function login() {
            const username = usernameInput.value;
            const password = passwordInput.value;
            
            // التحقق من بيانات الدخول
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                isAdmin = true;
                document.body.classList.add('admin-mode');
                loginModal.style.display = 'none';
                usernameInput.value = '';
                passwordInput.value = '';
                saveDataBtn.style.display = 'block'; // إظهار زر الحفظ
                renderData();
            } else {
                alert('بيانات الدخول غير صحيحة. يرجى المحاولة مرة أخرى.');
                usernameInput.focus();
            }
        }

        // تسجيل الخروج
        function logout() {
            isAdmin = false;
            document.body.classList.remove('admin-mode');
            saveDataBtn.style.display = 'none'; // إخفاء زر الحفظ
        }

        // حفظ التاريخ بعد التعديل
        function saveDate(inputElement) {
            window.appData.currentDate = inputElement.value;
            dateDisplayEl.textContent = window.appData.currentDate;
            inputElement.replaceWith(dateDisplayEl);
        }

        // عرض البيانات
        function renderData() {
            renderEvents();
            renderPayments();
            calculateTotals();
        }

        // عرض المناسبات في الجدول
        function renderEvents() {
            eventsTableBody.innerHTML = '';
            
            window.appData.events.forEach((event, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="${isAdmin ? 'editable' : ''}" 
                        contenteditable="${isAdmin}" 
                        data-field="name" 
                        data-index="${index}">${event.name}</td>
                    <td class="${isAdmin ? 'editable' : ''}" 
                        contenteditable="${isAdmin}" 
                        data-field="date" 
                        data-index="${index}">${event.date}</td>
                    <td class="${isAdmin ? 'editable' : ''}" 
                        contenteditable="${isAdmin}" 
                        data-field="amount" 
                        data-index="${index}">${event.amount}</td>
                    <td class="admin-only">
                        <button class="delete-btn" data-type="event" data-index="${index}">×</button>
                    </td>
                `;
                eventsTableBody.appendChild(row);
            });
            
            // إضافة مستمعي الأحداث للخلايا القابلة للتعديل
            if (isAdmin) {
                addEditableListeners('eventsTable', 'event');
            }
        }

        // عرض الدفعات في الجدول
        function renderPayments() {
            paymentsTableBody.innerHTML = '';
            
            window.appData.payments.forEach((payment, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="${isAdmin ? 'editable' : ''}" 
                        contenteditable="${isAdmin}" 
                        data-field="name" 
                        data-index="${index}">${payment.name}</td>
                    <td class="${isAdmin ? 'editable' : ''}" 
                        contenteditable="${isAdmin}" 
                        data-field="amount" 
                        data-index="${index}">${payment.amount}</td>
                    <td class="admin-only">
                        <button class="delete-btn" data-type="payment" data-index="${index}">×</button>
                    </td>
                `;
                paymentsTableBody.appendChild(row);
            });
            
            // إضافة مستمعي الأحداث للخلايا القابلة للتعديل
            if (isAdmin) {
                addEditableListeners('paymentsTable', 'payment');
            }
        }

        // إضافة مستمعي الأحداث للخلايا القابلة للتعديل
        function addEditableListeners(tableId, type) {
            const table = document.getElementById(tableId);
            const editableCells = table.querySelectorAll('.editable');
            
            editableCells.forEach(cell => {
                cell.addEventListener('input', function() {
                    const index = this.getAttribute('data-index');
                    const field = this.getAttribute('data-field');
                    const value = this.textContent.trim();
                    
                    // حماية ضد حقن HTML
                    const sanitizedValue = value.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    
                    if (type === 'event') {
                        if (field === 'amount') {
                            if (!isNaN(value)) {
                                window.appData.events[index][field] = parseInt(value) || 0;
                            } else {
                                this.textContent = window.appData.events[index][field];
                            }
                        } else {
                            window.appData.events[index][field] = sanitizedValue;
                        }
                    } else {
                        if (field === 'amount') {
                            if (!isNaN(value)) {
                                window.appData.payments[index][field] = parseInt(value) || 0;
                            } else {
                                this.textContent = window.appData.payments[index][field];
                            }
                        } else {
                            window.appData.payments[index][field] = sanitizedValue;
                        }
                    }
                    
                    calculateTotals();
                });
            });
            
            // مستمعي أحداث أزرار الحذف
            const deleteButtons = table.querySelectorAll('.delete-btn');
            deleteButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const index = this.getAttribute('data-index');
                    if (type === 'event') {
                        window.appData.events.splice(index, 1);
                    } else {
                        window.appData.payments.splice(index, 1);
                    }
                    renderData();
                });
            });
        }

        // إضافة مناسبة جديدة
        function addNewEvent() {
            window.appData.events.push({
                name: "عضو جديد",
                date: "1446/00/00هـ",
                amount: 500
            });
            renderData();
        }

        // إضافة دفعة جديدة
        function addNewPayment() {
            window.appData.payments.push({
                name: "عضو جديد",
                amount: 500
            });
            renderData();
        }

        // حساب المجاميع
        function calculateTotals() {
            // حساب إجمالي المناسبات
            const eventsTotal = window.appData.events.reduce((total, event) => total + event.amount, 0);
            
            // حساب إجمالي الدفعات
            const paymentsTotal = window.appData.payments.reduce((total, payment) => total + payment.amount, 0);
            
            // حساب المبلغ المتبقي
            const remaining = paymentsTotal - eventsTotal;
            
            // تحديث واجهة المستخدم
            eventsTotalEl.textContent = `${eventsTotal} ريال`;
            paymentsTotalEl.textContent = `${paymentsTotal} ريال`;
            
            remainingAmountEl.innerHTML = `
                <span class="${remaining < 0 ? 'negative' : 'positive'}">
                    ${remaining} ريال
                </span>
            `;
            
            // تحديث بطاقة الملخص
            summaryEventsEl.textContent = `${eventsTotal} ريال`;
            summaryPaymentsEl.textContent = `${paymentsTotal} ريال`;
            summaryRemainingEl.innerHTML = `
                <span class="${remaining < 0 ? 'negative' : 'positive'}">
                    ${remaining} ريال
                </span>
            `;
        }

        // عرض البيانات للمسؤول لنسخها
        function showDataForCopy() {
            // تحديث تاريخ التعديل
            window.appData.lastUpdate = new Date().toLocaleString('ar-SA', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // إنشاء نافذة عرض البيانات
            const dataDisplay = document.createElement('div');
            dataDisplay.className = 'data-display';
            
            // إنشاء عنصر نصي للنسخ
            const textarea = document.createElement('textarea');
            textarea.value = JSON.stringify(window.appData, null, 2);
            textarea.readOnly = true;
            
            // إنشاء عناصر التحكم
            const controls = document.createElement('div');
            controls.className = 'data-controls';
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'btn btn-primary';
            copyBtn.innerHTML = '<i class="fas fa-copy"></i> نسخ البيانات';
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'btn btn-danger';
            closeBtn.innerHTML = '<i class="fas fa-times"></i> إغلاق';
            
            const instructions = document.createElement('div');
            instructions.className = 'alert alert-info';
            instructions.style.margin = '10px';
            instructions.innerHTML = `
                <strong>تعليمات الحفظ:</strong>
                <ol>
                    <li>اضغط على زر "نسخ البيانات"</li>
                    <li>اذهب إلى مستودع GitHub</li>
                    <li>افتح ملف data.json</li>
                    <li>استبدل المحتوى بالبيانات المنسوخة</li>
                    <li>احفظ التغييرات</li>
                    <li>أغلق هذه النافذة</li>
                </ol>
            `;
            
            // إضافة العناصر
            dataDisplay.appendChild(textarea);
            controls.appendChild(copyBtn);
            controls.appendChild(closeBtn);
            dataDisplay.appendChild(controls);
            dataDisplay.appendChild(instructions);
            document.body.appendChild(dataDisplay);
            
            // تحديد النص تلقائياً
            textarea.select();
            
            // مستمع لزر النسخ
            copyBtn.addEventListener('click', () => {
                textarea.select();
                document.execCommand('copy');
                alert('تم نسخ البيانات بنجاح!');
            });
            
            // مستمع لزر الإغلاق
            closeBtn.addEventListener('click', () => {
                document.body.removeChild(dataDisplay);
            });
        }

        // بدء تشغيل التطبيق عند تحميل الصفحة
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
